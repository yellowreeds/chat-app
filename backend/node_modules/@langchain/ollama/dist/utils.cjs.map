{"version":3,"file":"utils.cjs","names":["messages: OllamaMessage","extra?: {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    responseMetadata?: Record<string, any>;\n    usageMetadata?: UsageMetadata;\n  }","AIMessageChunk","dataUrl: string","messages: AIMessage","toolCallMsgs: OllamaMessage | undefined","toolCalls: OllamaToolCall[] | undefined","message: HumanMessage","message: SystemMessage","message: ToolMessage","messages: BaseMessage[]"],"sources":["../src/utils.ts"],"sourcesContent":["import {\n  AIMessage,\n  AIMessageChunk,\n  BaseMessage,\n  HumanMessage,\n  MessageContentText,\n  SystemMessage,\n  ToolMessage,\n  UsageMetadata,\n} from \"@langchain/core/messages\";\nimport type {\n  Message as OllamaMessage,\n  ToolCall as OllamaToolCall,\n} from \"ollama\";\nimport { v4 as uuidv4 } from \"uuid\";\n\nexport function convertOllamaMessagesToLangChain(\n  messages: OllamaMessage,\n  extra?: {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    responseMetadata?: Record<string, any>;\n    usageMetadata?: UsageMetadata;\n  }\n): AIMessageChunk {\n  return new AIMessageChunk({\n    content: messages.content ?? \"\",\n    additional_kwargs:\n      messages.thinking && messages.thinking !== \"\"\n        ? { reasoning_content: messages.thinking }\n        : {},\n    tool_call_chunks: messages.tool_calls?.map((tc) => ({\n      name: tc.function.name,\n      args: JSON.stringify(tc.function.arguments),\n      type: \"tool_call_chunk\",\n      index: 0,\n      id: uuidv4(),\n    })),\n    response_metadata: extra?.responseMetadata,\n    usage_metadata: extra?.usageMetadata,\n  });\n}\n\nfunction extractBase64FromDataUrl(dataUrl: string): string {\n  const match = dataUrl.match(/^data:.*?;base64,(.*)$/);\n  return match ? match[1] : \"\";\n}\n\nfunction convertAMessagesToOllama(messages: AIMessage): OllamaMessage[] {\n  if (typeof messages.content === \"string\") {\n    return [\n      {\n        role: \"assistant\",\n        content: messages.content,\n      },\n    ];\n  }\n\n  const textFields = messages.content.filter(\n    (c) => c.type === \"text\" && typeof c.text === \"string\"\n  );\n  const textMessages = (textFields as MessageContentText[]).map((c) => ({\n    role: \"assistant\",\n    content: c.text,\n  }));\n  let toolCallMsgs: OllamaMessage | undefined;\n\n  if (\n    messages.content.find((c) => c.type === \"tool_use\") &&\n    messages.tool_calls?.length\n  ) {\n    // `tool_use` content types are accepted if the message has tool calls\n    const toolCalls: OllamaToolCall[] | undefined = messages.tool_calls?.map(\n      (tc) => ({\n        id: tc.id,\n        type: \"function\",\n        function: {\n          name: tc.name,\n          arguments: tc.args,\n        },\n      })\n    );\n\n    if (toolCalls) {\n      toolCallMsgs = {\n        role: \"assistant\",\n        tool_calls: toolCalls,\n        content: \"\",\n      };\n    }\n  } else if (\n    messages.content.find((c) => c.type === \"tool_use\") &&\n    !messages.tool_calls?.length\n  ) {\n    throw new Error(\n      \"'tool_use' content type is not supported without tool calls.\"\n    );\n  }\n\n  return [...textMessages, ...(toolCallMsgs ? [toolCallMsgs] : [])];\n}\n\nfunction convertHumanGenericMessagesToOllama(\n  message: HumanMessage\n): OllamaMessage[] {\n  if (typeof message.content === \"string\") {\n    return [\n      {\n        role: \"user\",\n        content: message.content,\n      },\n    ];\n  }\n  return message.content.map((c) => {\n    if (c.type === \"text\") {\n      return {\n        role: \"user\",\n        content: c.text,\n      };\n    } else if (c.type === \"image_url\") {\n      if (typeof c.image_url === \"string\") {\n        return {\n          role: \"user\",\n          content: \"\",\n          images: [extractBase64FromDataUrl(c.image_url)],\n        };\n      } else if (c.image_url.url && typeof c.image_url.url === \"string\") {\n        return {\n          role: \"user\",\n          content: \"\",\n          images: [extractBase64FromDataUrl(c.image_url.url)],\n        };\n      }\n    }\n    throw new Error(`Unsupported content type: ${c.type}`);\n  });\n}\n\nfunction convertSystemMessageToOllama(message: SystemMessage): OllamaMessage[] {\n  if (typeof message.content === \"string\") {\n    return [\n      {\n        role: \"system\",\n        content: message.content,\n      },\n    ];\n  } else if (\n    message.content.every(\n      (c) => c.type === \"text\" && typeof c.text === \"string\"\n    )\n  ) {\n    return (message.content as MessageContentText[]).map((c) => ({\n      role: \"system\",\n      content: c.text,\n    }));\n  } else {\n    throw new Error(\n      `Unsupported content type(s): ${message.content\n        .map((c) => c.type)\n        .join(\", \")}`\n    );\n  }\n}\n\nfunction convertToolMessageToOllama(message: ToolMessage): OllamaMessage[] {\n  if (typeof message.content !== \"string\") {\n    throw new Error(\"Non string tool message content is not supported\");\n  }\n  return [\n    {\n      role: \"tool\",\n      content: message.content,\n    },\n  ];\n}\n\nexport function convertToOllamaMessages(\n  messages: BaseMessage[]\n): OllamaMessage[] {\n  return messages.flatMap((msg) => {\n    if ([\"human\", \"generic\"].includes(msg._getType())) {\n      return convertHumanGenericMessagesToOllama(msg);\n    } else if (msg._getType() === \"ai\") {\n      return convertAMessagesToOllama(msg);\n    } else if (msg._getType() === \"system\") {\n      return convertSystemMessageToOllama(msg);\n    } else if (msg._getType() === \"tool\") {\n      return convertToolMessageToOllama(msg as ToolMessage);\n    } else {\n      throw new Error(`Unsupported message type: ${msg._getType()}`);\n    }\n  });\n}\n"],"mappings":"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"}